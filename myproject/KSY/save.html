<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 카카오 우편번호 찾기 API 스크립트 -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: left; /* 텍스트를 왼쪽 정렬 */
            max-width: 1000px; /* Increased to accommodate larger screens */
            width: 100%;
            margin: 20px;
        }

         h2 {
            margin-bottom: 20px;
            font-size: 25px; /* Increased to make the headers more prominent */
            text-align: left; /* 제목을 왼쪽 정렬 */
        }

        .container h2 {
            font-size: 25px; /* Adjusted based on parent font-size for consistency */
            margin-bottom: 10px;
            text-align: left;
        }

        .container form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            font-size: 23px; /* 전체 label 태그 폰트 크기 */
            display: block;
            margin-bottom: 5px;
            text-align: left; /* 레이블을 왼쪽 정렬 */
        }

        input, textarea, select {
            width: 100%;
            padding: 16px; /* Increased padding for better touch experience */
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .prdbutton {
            font-size: 17px;
            padding: 15px 25px;
            border: none;
            background-color: grey;
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            margin-right: 8px"
        }

        .prdactive {
            background-color: orange; /* 선택된 버튼 배경색 주황색 */
        }

        input[type="submit"] {
            background-color: #FF5722;
            color: #fff;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 18px; /* Adjusted for larger screens */
            border-radius: 10px;
            margin-top: 20px;
        }

        input[type="submit"]:hover {
            background-color: #00B2B6;
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 14px 20px;
            text-align: center;
        }

        th {
            background-color: #f5f5f5;
            color: #333;
        }

        td {
            border-bottom: 1px solid #ddd;
        }
    .popbtn {
        padding: 5px 10px;
        margin-top: 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
         cursor: pointer;
    }

    .popbtn:hover {
        background-color: #45a049;
    }

    #searchCustomerBtn, #searchRecipientBtn {
        padding: 15px 30px;
        margin: 5px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        font-size: 18px;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #searchCustomerBtn:hover, #searchRecipientBtn:hover {
        background-color: #45a049;
        transform: scale(1.05);
    }

    .popbtn:active, #searchCustomerBtn:active, #searchRecipientBtn:active {
        background-color: #3e8e41;
        transform: scale(0.98);
    }
     #postcodeButton {
         margin-top: 10px;
     }
        /* [zip] 모달 배경 */
        #modalBackground-zip {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* [zip] 모달 박스 */
        #modalContent-zip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            width: 90%;
            max-width: 400px;
            height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            z-index: 1001;
        }

        /* [zip] 닫기 버튼 */
        #modalCloseBtn-zip {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff4d4f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            text-align: center;
            line-height: 30px;
            cursor: pointer;
            font-size: 18px;
        }

        /* 숨기기 */
        .hidden {
            display: none;
        }
    </style>
    <title>가을단감농원_주문화면</title>
</head>
<body>
    <div class="container">

        <h1>주문 정보 입력</h1>
        <form id="productForm" method="POST" action="/save" >
            <div class="form-group" style="display: flex; gap: 10px;">
              <div class="divproduct1" style="flex: 1;">
                    <label>중량:</label>
                    <input type="hidden" id="selectedProductCd" name="selectedProductCd" value="">
                    <!--<button id="button1" class="prdbutton" type="button" data-cd="3">3</button>
                    <button id="button2" class="prdbutton" type="button" data-cd="5">5</button>
                    <button id="button3" class="prdbutton" type="button" data-cd="10">10</button>-->
                    <button id="button4" class="prdbutton" type="button" data-cd="1">블루베리</button>
              </div>
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div class="divproduct2" style="flex: 1;">
                    <label for="productSelect">제품명:</label>
                        <input type="hidden" id="productid" name="productid" readonly>
                        <input type="hidden" id="productname" name="productname" readonly>

                    <select id="productSelect" name="productSelect" required style="width: 45%; font-size: 20px;" >
                        <option value="">선택하세요</option>
                    </select>
                </div>
<!--                <div class="divproduct3" style="flex: 1;">
                    <label for="quantity">수량:</label>
                    <input type="number" id="quantity" name="quantity" maxlength="3"  oninput="maxLengthCheck(this)"  required style="font-size: 18px;">
                </div>-->
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div class="divproduct3" style="flex: 1;">
                    <label for="quantity">수량:</label>
                    <input type="number" id="quantity" name="quantity" maxlength="3"  oninput="maxLengthCheck(this)"  required style="width: 45%; font-size: 18px;">
                </div>
            </div>

            <h2>주문자 정보</h2>
            <div class="form-group" style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <label for="customerName">주문자 이름:</label>
                    <input  type="text" id="customerName" name="customerName" required style="width: 45%; font-size: 18px; ">
                    <button type="button" id="searchCustomerBtn" >검색</button>
                </div>
            </div>
            <div class="form-group">
                <label for="customerPhone">주문자 전화번호:</label>
                <input type="text" class="input-field" id="customerPhone" name="customerPhone" maxlength="13"  onkeypress="validateNumberInput(event)" onblur="formatPhoneNumber(this)" oninput="formatPhoneNumber(this)" required style="font-size: 18px;" >
            </div>

            <h2>수령자 정보</h2>
            <div class="form-group">
                <label for="recipientName">수령자 이름:</label>
                <input type="text" id="recipientName" name="recipientName" required style="width: 45%; font-size: 18px; ">
                <button type="button"id="searchRecipientBtn" >검색</button>
            </div>
            <div class="form-group">
                <label for="recipientPhone">수령자 전화번호:</label>
                <input type="text" id="recipientPhone" name="recipientPhone" maxlength="13" onkeypress="validateNumberInput(event)" onblur="formatPhoneNumber(this)" oninput="formatPhoneNumber(this)" required style="font-size: 18px; " >

            </div>
            <div class="form-group">
                <label for="zipCode">수령자 우편번호:</label>
                <input type="text" id="zipCode" name="zipCode" maxlength="7"  onkeypress="validateNumberInput(event)"    style="width: 40%; font-size: 18px; " readonly>
                <button type="button" id="postcodeButton" style=" font-size: 18px; padding: 15px 30px; border: none; background-color: #FFD400; color: #fff; border-radius: 10px; cursor: pointer;" >우편번호</button>
            </div>
            <div class="form-group">
                <label for="address1">수령자 기본 주소:</label>
                <input type="text" id="address1" name="address1" required style="font-size: 18px; " >
            </div>
            <div class="form-group">
                <label for="address2">수령자 나머지 주소:</label>
                <input type="text" id="address2" name="address2" style="font-size: 18px; " >
            </div>
            <div class="form-group">
                <label for="orderRemark">비고:</label>
                <input type="text" id="orderRemark" name="orderRemark" style="font-size: 18px; " >
            </div>

            <input type="submit" value="주문하기">
        </form>
    </div>
    <!-- 모달 -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <table id="customerTable">
                <thead>
                    <tr>
                        <th>이름</th>
                        <th>전화번호</th>
                        <th>선택</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 고객 정보가 여기에 추가됩니다 -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- [zip] 모달 구조 -->
    <div id="modalBackground-zip" class="modal-background">
        <div id="modalContent-zip" class="modal-content">
            <button id="modalCloseBtn-zip" class="modal-close-btn">&times;</button>
            <div id="postcodeEmbed-zip" style="width: 100%; height: 100%;"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const buttons = document.querySelectorAll('.prdbutton');
            const selectBox = document.getElementById('productSelect');
            const selectedProductCdInput = document.getElementById('selectedProductCd');
            const productForm = document.getElementById('productForm');
            let tb_product = [];

            function fetchProducts() {
                fetch('/api/products')
                    .then(response => response.json())
                    .then(data => {
                        tb_product = data;
                    })
                    .catch(error => console.error('Error fetching product data:', error));
            }

            fetchProducts();

            // 버튼 클릭 이벤트 설정
            buttons.forEach(button => {
                button.addEventListener('click', function () {
                    buttons.forEach(btn => btn.classList.remove('prdactive'));
                    this.classList.add('prdactive');

                    const product_cd = this.dataset.cd;

                    while (selectBox.options.length > 1) {
                        selectBox.remove(1);
                    }

                    // tb_product 배열에서 product_cd 값 추가
                    tb_product.forEach(product => {
                        if (product.product_cd === product_cd) {
                            const option = document.createElement('option');
                            option.value = product.product_id;
                            option.text = product.product_name;
                            selectBox.add(option);

                        }
                    });

                    selectBox.selectedIndex = 1;
                    selectedProductCdInput.value = product_cd;
                    // 버튼 선택 후 change 이벤트 트리거
                    const event = new Event('change');
                    selectBox.dispatchEvent(event);
                });
            });

            productSelect.addEventListener('change', event => {
                const selectedOption = event.target.options[event.target.selectedIndex];
                const productId = selectedOption.value;
                const productName = selectedOption.text;

                document.getElementById('productid').value = productId;
                document.getElementById('productname').value = productName;

            });
            // 입력 필드에서 "Enter" 키로 폼 제출 방지
            productForm.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // 기본 엔터키 제출 동작 차단
                }
            });
            //메세지 처리
            productForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(productForm);

                fetch(productForm.action, {
                    method: productForm.method,
                    body: formData
                }).then(response => response.text())
                .then(text => {
                    alert("주문이 성공적으로 저장되었습니다.");  // 메시지 창 표시
                    window.location.href = '/save';
                }).catch(error => {
                    console.error('Error submitting order:', error);
                });
            });
        });

            // 주문자 및 수령자 검색 관련 함수
            const searchCustomerBtn = document.getElementById('searchCustomerBtn');
            const searchRecipientBtn = document.getElementById('searchRecipientBtn'); // 추가된 요소
            const customerInputs = {
                name: document.getElementById('customerName'),
                phone: document.getElementById('customerPhone'),
                recipientName: document.getElementById('recipientName'),
                recipientPhone: document.getElementById('recipientPhone'),
                zipCode: document.getElementById('zipCode'),
                address1: document.getElementById('address1'),
                address2: document.getElementById('address2'),
                orderRemark: document.getElementById('orderRemark')
            };

            const modal = document.getElementById('customerModal');
            const closeModalBtn = document.querySelector('.modal .close');

            // 검색 버튼의 기본 동작 방지 및 검색 기능 실행
            searchCustomerBtn.addEventListener('click', function(event) {
                event.preventDefault();
                const name = customerInputs.name.value.trim();
                searchCustomer(name, populateCustomerInfo);
            });

            searchRecipientBtn.addEventListener('click', function(event) {
                event.preventDefault();
                const name = customerInputs.recipientName.value.trim();
                searchCustomer(name, populateRecipientInfo);
            });

            closeModalBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });

            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // 고객 정보 맵핑
            function populateCustomerInfo(customer) {
                customerInputs.name.value = customer.customer_name;
                customerInputs.phone.value = customer.customer_phone;
                customerInputs.recipientName.value = customer.customer_name;
                customerInputs.recipientPhone.value = customer.customer_phone;
                customerInputs.zipCode.value = customer.customer_post;
                customerInputs.address1.value = customer.customer_address;
                customerInputs.address2.value = customer.customer_address2;
                customerInputs.orderRemark.value = customer.customer_remark;
            }

            // 수령자 정보 맵핑
            function populateRecipientInfo(customer) {
                customerInputs.recipientName.value = customer.customer_name;
                customerInputs.recipientPhone.value = customer.customer_phone;
                customerInputs.zipCode.value = customer.customer_post;
                customerInputs.address1.value = customer.customer_address;
                customerInputs.address2.value = customer.customer_address2;
                customerInputs.orderRemark.value = customer.customer_remark;
            }

            // 고객 및 수령자 검색 수행 함수
            function searchCustomer(name, callback) {
                const isFetchingAll = !name;
                const endpoint = isFetchingAll ? '/search_customer/all' : `/search_customer/${name}`;

                fetch(endpoint)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(customers => {
                        console.log(`Fetched ${isFetchingAll ? 'all' : 'specific'} customers:`, customers);
                        if (customers.length === 1) {
                            callback(customers[0]);
                        } else {
                            openModalWithCustomers(customers, callback);
                        }
                    })
                    .catch(error => console.error(`Error fetching ${isFetchingAll ? 'all' : 'specific'} customers:`, error));
            }

            function openModalWithCustomers(customers, callback) {
                const tbody = document.querySelector('#customerTable tbody');
                tbody.innerHTML = ''; // 기존 데이터 초기화

                if (customers.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.setAttribute('colspan', '3');
                    td.textContent = '고객 정보가 없습니다.';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                } else {
                    customers.forEach(function(customer) {
                        const tr = document.createElement('tr');

                        const tdName = document.createElement('td');
                        tdName.textContent = customer.customer_name;
                        tr.appendChild(tdName);

                        const tdPhone = document.createElement('td');
                        tdPhone.textContent = customer.customer_phone;
                        tr.appendChild(tdPhone);

                        const tdSelect = document.createElement('td');
                        const selectBtn = document.createElement('button');
                        selectBtn.textContent = '선택';
                        selectBtn.classList.add('popbtn');
                        selectBtn.addEventListener('click', function() {
                            callback(customer);
                            modal.style.display = 'none';
                        });
                        tdSelect.appendChild(selectBtn);
                        tr.appendChild(tdSelect);

                        tbody.appendChild(tr);
                    });
                }

                modal.style.display = 'flex';
            }

        //숫자 처리
        function validateNumberInput(event) {
            const key = event.key;
            if (!/[0-9]/.test(key)) {
                event.preventDefault();
            }
        }

        //전화번호 처리
        function formatPhoneNumber(input) {
            const value = input.value.replace(/[^0-9]/g, '');

            let formattedValue = '';
            if (value.length < 10) {
                input.value = value;
                return;
            } else if (value.startsWith('02')) { // Handling Seoul local numbers (e.g. 02-1234-5678)
                formattedValue = value.replace(/(\d{2})(\d{3,4})(\d{4})/, '$1-$2-$3');
            } else {
                formattedValue = value.replace(/(\d{3})(\d{3,4})(\d{4})/, '$1-$2-$3');
            }

            input.value = formattedValue;
        }

        //수량 3자리 처리
        function maxLengthCheck(input) {
            if (input.value.length > 3) {
                input.value = input.value.slice(0, 3);
            }
        }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('postcodeButton').addEventListener('click', function () {
            // 동적으로 모달 영역 생성
            const modalDiv = document.createElement('div');
            modalDiv.id = 'modal-zip';
            modalDiv.style.position = 'fixed';
            modalDiv.style.top = '0';
            modalDiv.style.left = '0';
            modalDiv.style.width = '100%';
            modalDiv.style.height = '100%';
            modalDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modalDiv.style.zIndex = '1000';
            modalDiv.style.display = 'flex';
            modalDiv.style.alignItems = 'center';
            modalDiv.style.justifyContent = 'center';

            // 검색 창 컨테이너 크기 2배 확대
            const innerDiv = document.createElement('div');
            innerDiv.style.position = 'relative';
            innerDiv.style.width = '90%'; // 기존 화폭 비율 유지
            innerDiv.style.maxWidth = '600px'; // 기존 `400px`에서 2배 증가
            innerDiv.style.height = '600px'; // 기존 높이도 2배 증가
            innerDiv.style.backgroundColor = '#FFF';
            innerDiv.style.borderRadius = '8px';
            innerDiv.style.overflow = 'hidden';

            // 닫기 버튼
            const closeButton = document.createElement('button');
            closeButton.innerText = '×';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.background = '#ff4d4f';
            closeButton.style.color = '#FFF';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '50%';
            closeButton.style.width = '30px';
            closeButton.style.height = '30px';
            closeButton.style.textAlign = 'center';
            closeButton.style.lineHeight = '30px';
            closeButton.style.cursor = 'pointer';
            innerDiv.appendChild(closeButton);

            // 모달 닫기 이벤트
            closeButton.addEventListener('click', function () {
                document.body.removeChild(modalDiv);
            });

            // 모달의 배경 클릭 시 닫기
            modalDiv.addEventListener('click', function (e) {
                if (e.target === modalDiv) {
                    document.body.removeChild(modalDiv);
                }
            });

            // 모달 구조 삽입
            modalDiv.appendChild(innerDiv);
            document.body.appendChild(modalDiv);

            // 카카오 주소 검색기 삽입
            new daum.Postcode({
                oncomplete: function (data) {
                    // 도로명 주소, 지번 주소, 우편번호 저장
                    const roadAddr = data.roadAddress;
                    const jibunAddr = data.jibunAddress;
                    const zoneCode = data.zonecode;

                    // 결과를 입력 필드에 반영
                    document.getElementById('zipCode').value = zoneCode;
                    document.getElementById('address1').value = roadAddr || jibunAddr;

                    // 선택된 주소를 알림으로 표시
                    //alert('Selected address: ' + (roadAddr || jibunAddr));

                    // 모달 닫기
                    document.body.removeChild(modalDiv);
                },
                width: '100%', // 검색 창의 너비 100% 활용
                height: '100%', // 검색 창의 높이를 컨테이너에 맞춤
            }).embed(innerDiv);
        });
    });


    </script>

</body>
</html>